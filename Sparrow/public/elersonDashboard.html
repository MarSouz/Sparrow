<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/dashboard/dashAdm.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./assets/imgs/Logo2.png" type="image/x-icon">
    <title>Dashboard | Visão geral das máquinas</title>
</head>

<body onload="buscarMedidasDispersao()">
    <div class="menu-lateral">
        <nav id="nav">
            <ul>
                <li>
                    <a href="#" class="logo">
                        <img src="../assets/imgs/Logo2.png" alt="">
                        <span class="nav-item">Sparrow</span>
                    </a>
                </li>

                <li>
                    <a href="./preDashAdm.html">
                        <i class="bx bxs-home"></i>
                        <span class="nav-item">Início</span>
                    </a>
                </li>

                <li>
                    <a href="./../AlteracoesFunc.html">
                        <i class="bx bxs-user"></i>
                        <span class="nav-item">Funcionários</span>
                    </a>
                </li>

                <li>
                    <a href="./dashAdm.html">
                        <i class="bx bx-radar"></i>
                        <span class="nav-item">Terminais</span>
                    </a>
                </li>

                <li>
                    <a href="./dashAdmServidor.html">
                        <i class="bx bxs-server"></i>
                        <span class="nav-item">Servidores</span>
                    </a>
                </li>

                <li>
                    <a href="./../crudTerminal.html">
                        <i class="bx bx-laptop"></i>
                        <span class="nav-item">Gerenciamento de terminais</span>
                    </a>
                </li>

                <li>
                    <a href="./../crudServidor.html">
                        <i class="bx bx-laptop"></i>
                        <span class="nav-item">Gerenciamento de servidores</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <i class="bx bxs-help-circle"></i>
                        <span class="nav-item">Central de atendimento</span>
                    </a>
                </li>

                <li>
                    <a href="#" id="logoutBotao" class="logout">
                        <i class="bx bx-log-out"></i>
                        <span class="nav-item">Sair</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="father">
        <div class="content1">
            <span class="titulo">Dashboard | Visão geral das máquinas</span>
            <div class="periodo">
                <button onclick="periodo7()">7 dias</button>
                <button onclick="perido15()">15 dias</button>
                <button onclick="periodo30()">30 dias</button>
            </div>
            <div class="dados">
                <button onclick="cpuXram()">CPU x RAM</button>
                <button onclick="pacotes()">Pacotes Enviados x Recebidos</button>
            </div>
        </div>
        <div class="content2">
            <div class="graficoLinha">
                <canvas id="scatterChart"></canvas>
            </div>
            <div class="card">
                <span>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Obcaecati aspernatur laboriosam, unde
                    quasi quidem in soluta, ipsam quod eligendi eveniet, reprehenderit repellendus sunt quis aliquid
                    voluptatem. Nobis veritatis alias qui!</span>
            </div>
        </div>
        <div class="boxplot" style="display: none;" id="lero">
            <div onclick="toggleLero()" class="fechar">
                <img src="./assets/svg/icon-close.svg" alt="">
            </div>
            <div id="boxplot"></div>
        </div>
        <div id="blurOverlay" class="blur-overlay"></div>
    </div>
</body>

</html>

<script>
    let scatterChartInstance
    var perido = 7
    var dado1 = 1
    var dado2 = 2
    let texto1 = "Media de Uso de CPU"
    let texto2 = "Media de Uso de RAM"

    function cpuXram() {
        dado1 = 1
        dado2 = 2
        texto1 = "Media de Uso de CPU"
        texto2 = "Media de Uso de RAM"
        buscarMedidasDispersao()
    }

    function pacotes() {
        dado1 = 4
        dado2 = 5
        texto1 = "Media de Pacotes Recebidos"
        texto2 = "Media de Pacotes Enviados"
        buscarMedidasDispersao()
    }

    function perido7() {
        perido = 7
        buscarMedidasDispersao()
    }

    function perido15() {
        perido = 15
        buscarMedidasDispersao()
    }

    function periodo30() {
        perido = 30
        buscarMedidasDispersao()
    }
    function buscarMedidasDispersao() {
        fetch(`/elerson/buscar/${sessionStorage.ID_EMPRESA}/${perido}/${dado1}/${dado2}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    console.log("error")
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));
                    plotarDispersao(resposta)
                }

                )
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    // Preparando os dados para o Chart.js
    function plotarDispersao(dadosMedias) {

        if (scatterChartInstance) {
            scatterChartInstance.destroy();
        }

        const data = {
            datasets: [{
                label: 'Máquinas',
                data: dadosMedias.map(d => ({
                    x: d.dado1,
                    y: d.dado2,
                    maquina: d.fk_maquina // Armazena o ID da máquina para os rótulos
                })),
                backgroundColor: 'blue',
                pointRadius: 5
            }]
        };

        // Configurações do gráfico
        const config = {
            type: 'scatter',
            data: data,
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: texto1
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: texto2
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const maquina = context.raw.maquina;
                                const xValue = context.raw.x;
                                const yValue = context.raw.y;
                                if (texto1 == 'Media de Uso de CPU') {
                                    return `Máquina ${maquina}: CPU ${xValue}, RAM ${yValue}`;
                                }
                                else {
                                    return `Máquina ${maquina}: Enviados ${xValue}, Recebidos ${yValue}`;
                                }
                            }
                        }
                    }
                },
                // Função de evento onClick
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        // Obtendo o índice do ponto clicado
                        const index = elements[0].index;
                        const machineData = data.datasets[0].data[index];

                        // Exibindo o ID da máquina e os dados
                        // alert(`Máquina ${machineData.maquina}: Média de Pacotes Enviados = ${machineData.x}, Média de Pacotes Recebidos = ${machineData.y}`);
                        buscarMedidasBoxplot(machineData.maquina, perido, dado1, dado2)
                        // Aqui você pode chamar uma função para exibir um boxplot
                        // exemplo: exibirBoxplot(machineData.maquina);
                    }
                }
            }
        };

        // Inicializando o gráfico
        const ctx = document.getElementById('scatterChart').getContext('2d');
        scatterChartInstance = new Chart(ctx, config);
    }

    function buscarMedidasBoxplot(fk_maquina, periodo, dado1, dado2) {
        fetch(`/elerson/buscar/boxplot/${sessionStorage.ID_EMPRESA}/${fk_maquina}/${periodo}/${dado1}/${dado2}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    console.log("error")
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));
                    plotarBoxplot(resposta)
                }

                )
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function plotarBoxplot(resposta) {
        const lero = document.getElementById("lero");
        const blurOverlay = document.getElementById("blurOverlay");

        // Alterna entre mostrar ou esconder
        if (lero.style.display === "none" || lero.style.display === "") {
            lero.style.display = "flex"; // Mostra a div
            blurOverlay.style.display = "block"; // Mostra o fundo embaçado
        } else {
            lero.style.display = "none"; // Esconde a div
            blurOverlay.style.display = "none"; // Esconde o fundo embaçado
        }
        lero.style.display = 'block';
        var data = []
        for (var index = 0; index < resposta.length; index++) {
            var box = {
                type: 'box',
                q1: [resposta[index].primeiro_quartil],
                median: [resposta[index].mediana],
                q3: [resposta[index].terceiro_quartil],
                lowerfence: [resposta[index].minimo],
                upperfence: [resposta[index].maximo],
                name: 'Grupo 1',
                marker: { color: 'rgba(75, 192, 192, 1)' },
                boxpoints: false
            }
            data.push(box)
        }
        var layout = {
            title: 'Boxplot com Dados Especificados',
            yaxis: { title: 'Valores' },
            boxmode: 'group'  // Agrupa os boxplots lado a lado
        };
        Plotly.newPlot('boxplot', data, layout);


    }
    function toggleLero() {
        lero.style.display = "none"; // Esconde a div
        blurOverlay.style.display = "none"; // Esconde o fundo embaçado
    }

</script>